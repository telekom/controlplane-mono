name: go-build-test

on:
  workflow_dispatch:
  push:
    branches:
      - "main"
      - "feature/**"
      - "feat/**"
      - "release/**"
      - "dependabot/**"
  pull_request:
    branches:
      - "main"
    paths:
      - 'common/**'
      - 'common-server/**'
      - 'secret-manager/**'
      - 'gateway/**'
      - 'identity/**'

jobs:

  prepare:
    runs-on: ubuntu-latest
    outputs:
      subprojects: ${{ steps.matrix.outputs.subprojects }}
      operators: ${{ steps.matrix.outputs.operators }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # pin@v4.2.2
      - name: Setup Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # pin@5.5.0
      - name: Detect Changes
        id: detect-changes
        uses: ron96G/monutil@v1.1.2
        with:
          base-commit: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.sha || github.event_name == 'push' && github.event.before }}
          head-commit: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.sha || github.event_name == 'push' && github.sha }}
      - name: Print changed modules
        run: |
          echo "Changed modules output:"
          echo "${{ steps.detect-changes.outputs.changed-modules }}"
      - name: Build Matrix
        id: matrix
        run: |
          subprojects=$(find . -maxdepth 3 -type f -name Makefile | cut -f2 -d/ | jq -R -s -c 'split("\n") | map(select(length > 0))')
          operators=$(find . -maxdepth 3 -type f -name main.go | cut -f2 -d/ | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "subprojects=$subprojects" >> $GITHUB_OUTPUT
          echo "operators=$operators" >> $GITHUB_OUTPUT

  test:
    name: Run unit tests
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      fail-fast: false # run all tests even if one fails
      matrix:
        subproject: ${{ fromJson(needs.prepare.outputs.subprojects) }}
    permissions:
      pull-requests: write
      checks: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # pin@v4.2.2
      - name: Setup Go
        uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # pin@5.5.0
        with:
          go-version-file: ${{ matrix.subproject }}/go.mod
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/.go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - name: Set up gotestfmt
        uses: gotesttools/gotestfmt-action@v2

      - name: Build and test subproject
        run: make test
        working-directory: ${{ matrix.subproject }}
        env:
          ENVTEST_K8S_VERSION: "1.31.0"

      - name: Upload test log
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # pin@v4.6.2
        if: always()
        with:
          name: test-log-${{ matrix.subproject }}
          path: /tmp/gotest.log
          if-no-files-found: error
          
  build-operators:
    name: Build operators
    runs-on: ubuntu-latest
    needs: [prepare, test]
    strategy:
      fail-fast: false
      matrix:
        subproject: ${{ fromJson(needs.prepare.outputs.operators) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: ${{ matrix.subproject }}/go.mod
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/.go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}

      - uses: ko-build/setup-ko@v0.8
      - name: Inject slug vars
        uses: rlespinasse/github-slug-action@v5
      - run: ko build ${{ matrix.subproject }}/cmd/main.go --bare --tags ${GITHUB_REF_SLUG}
        env:
          KO_DOCKER_REPO: ghcr.io/telekom/controlplane-mono/${{ matrix.subproject }}
        working-directory: ${{ matrix.subproject }}


# TODO: build other subprojects